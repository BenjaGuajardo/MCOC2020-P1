from numpy import *
import scipy as sp
from scipy.integrate import odeint
from leer_eof import leer_eof
from sys import argv

#Terminos zonales  ("Jn"), son los C[n,0], notar que S[n,0] = 0

Nt = 8
C = zeros((Nt+1,Nt+1))
S = zeros((Nt+1,Nt+1))

# n,m     n m       Jn
C[2,0], S[2,0] =   -0.10826360229840E-02   ,     0.0
C[3,0], S[3,0] =    0.25324353457544E-05   ,     0.0
C[4,0], S[4,0] =    0.16193312050719E-05   ,     0.0
C[5,0], S[5,0] =    0.22771610163688E-06   ,     0.0
C[6,0], S[6,0] =   -0.53964849049834E-06   ,     0.0
C[7,0], S[7,0] =    0.35136844210318E-06   ,     0.0
C[8,0], S[8,0] =    0.20251871520885E-06   ,     0.0

#Terminos teserales Cmn y Smn
# n,m     n m       Cmn                          Smn
C[2,1], S[2,1] =   -0.24140000522221E-09   ,     0.15430999737844E-08
C[3,1], S[3,1] =    0.21927988018965E-05   ,     0.26801189379726E-06
C[4,1], S[4,1] =   -0.50872530365024E-06   ,    -0.44945993508117E-06
C[5,1], S[5,1] =   -0.53716510187662E-07   ,    -0.80663463828530E-07
C[6,1], S[6,1] =   -0.59877976856303E-07   ,     0.21164664354382E-07
C[7,1], S[7,1] =    0.20514872797672E-06   ,     0.69369893525908E-07
C[8,1], S[8,1] =    0.16034587141379E-07   ,     0.40199781599510E-07 
C[2,2], S[2,2] =    0.15745360427672E-05   ,    -0.90386807301869E-06
C[3,2], S[3,2] =    0.30901604455583E-06   ,    -0.21140239785975E-06
C[4,2], S[4,2] =    0.78412230752366E-07   ,     0.14815545694714E-06
C[5,2], S[5,2] =    0.10559053538674E-06   ,    -0.52326723987632E-07
C[6,2], S[6,2] =    0.60120988437373E-08   ,    -0.46503948132217E-07
C[7,2], S[7,2] =    0.32844904836492E-07   ,     0.92823143885084E-08
C[8,2], S[8,2] =    0.65765423316743E-08   ,     0.53813164055056E-08
C[3,3], S[3,3] =    0.10055885741455E-06   ,     0.19720132389889E-06
C[4,3], S[4,3] =    0.59215743214072E-07   ,    -0.12011291831397E-07
C[5,3], S[5,3] =   -0.14926153867389E-07   ,    -0.71008771406986E-08
C[6,3], S[6,3] =    0.11822664115915E-08   ,     0.18431336880625E-09
C[7,3], S[7,3] =    0.35285405191512E-08   ,    -0.30611502382788E-08
C[8,3], S[8,3] =   -0.19463581555399E-09   ,    -0.87235195047605E-09
C[4,4], S[4,4] =   -0.39823957404129E-08   ,     0.65256058113396E-08
C[5,4], S[5,4] =   -0.22979123502681E-08   ,     0.38730050770804E-09
C[6,4], S[6,4] =   -0.32641389117891E-09   ,    -0.17844913348882E-08
C[7,4], S[7,4] =   -0.58511949148624E-09   ,    -0.26361822157867E-09
C[8,4], S[8,4] =   -0.31893580211856E-09   ,     0.91177355887255E-10
C[5,5], S[5,5] =    0.43047675045029E-09   ,    -0.16482039468636E-08
C[6,5], S[6,5] =   -0.21557711513900E-09   ,    -0.43291816989540E-09
C[7,5], S[7,5] =    0.58184856030873E-12   ,     0.63972526639235E-11
C[8,5], S[8,5] =   -0.46151734306628E-11   ,     0.16125208346784E-10
C[6,6], S[6,6] =    0.22136925556741E-11   ,    -0.55277122205966E-10
C[7,6], S[7,6] =   -0.24907176820596E-10   ,     0.10534878629266E-10
C[8,6], S[8,6] =   -0.18393642697634E-11   ,     0.86277431674150E-11
C[7,7], S[7,7] =    0.25590780149873E-13   ,     0.44759834144751E-12 
C[8,7], S[8,7] =    0.34297618184624E-12   ,     0.38147656686685E-12 
C[8,8], S[8,8] =   -0.15803322891725E-12   ,     0.15353381397148E-12

eofname = argv[1]

tiempo, x, y, z, vx, vy, vz = leer_eof(eofname)

deltaT = tiempo[-1]
z0 = [x[0],y[0],z[0],vx[0],vy[0],vz[0]]

''' PARAMETROS '''

km3 = (1000.)**3
km5 = (1000.)**5
km6 = (1000.)**6
km7 = (1000.)**7
km8 = (1000.)**8

G = 6.67408e-11
mt = 5.972e24
Rn = 6378136.3  

μ = 398600.4415*km3
Ω = 7.2921150e-5

J2 = -C[2,0]*μ*Rn**2
J3 = -C[3,0]*μ*Rn**3
J4 = -C[4,0]*μ*Rn**4
J5 = -C[5,0]*μ*Rn**5
J6 = -C[6,0]*μ*Rn**6
J7 = -C[7,0]*μ*Rn**7
J9 = -C[8,0]*μ*Rn**8

''' FUNCION SATELITE '''

def satelite(z,t):

    c = cos(Ω*t)
    s = sin(Ω*t)
    
    R = array([
            [c, -s, 0],
            [s,  c, 0],
            [0,  0, 1]])
    
    Rp = Ω*array([
            [-s, -c, 0],
            [ c, -s, 0],
            [ 0,  0, 0]])
    
    Rpp = (Ω**2)*array([
            [-c,  s, 0],
            [-s, -c, 0],
            [ 0,  0, 0]])
    
    x = z[0:3]
    xp = z[3:6] 
    
    r = sqrt(dot(x,x))
    
    xc  = R@x
    norma = xc/r
    Fg = -(μ/r**2)*norma
    
    FJ2 = zeros(3)
    FJ2[0]=J2*xc[0]/(r**7)*(6*xc[2]**2-1.5*(xc[0]**2 + xc[1]**2))
    FJ2[1]=J2*xc[1]/(r**7)*(6*xc[2]**2-1.5*(xc[0]**2 + xc[1]**2))        
    FJ2[2]=J2*xc[2]/(r**7)*(3*xc[2]**2-4.5*(xc[0]**2 + xc[1]**2))  

    FJ3=zeros(3)
    FJ3[0] = J3*xc[0]*xc[2] / r**9 * (10*xc[2]**2-7.5*(xc[0]**2 + xc[1]**2))
    FJ3[1] = J3*xc[1]*xc[2] / r**9 * (10*xc[2]**2-7.5*(xc[0]**2 + xc[1]**2))
    FJ3[2] = J3*1 / r**9 * (4*xc[2]**2*(xc[2]**2-3*(xc[0]**2 + xc[1]**2))+1.5*((xc[0]**2 + xc[1]**2)**2))  
    
    FJ4 = zeros(3)
    FJ4[0] = -5*xc[0]*(35*xc[2]**4/(8*(xc[0]**2 + xc[1]**2 + xc[2]**2)**2) - 15*xc[2]**2/(4*(xc[0]**2 + xc[1]**2 + xc[2]**2)) + 0.375)/(xc[0]**2 + xc[1]**2 + xc[2]**2)**(7/2) + (-35*xc[0]*xc[2]**4/(2*(xc[0]**2 + xc[1]**2 + xc[2]**2)**3) + 15*xc[0]*xc[2]**2/(2*(xc[0]**2 + xc[1]**2 + xc[2]**2)**2))/(xc[0]**2 + xc[1]**2 + xc[2]**2)**(5/2)
    FJ4[1] = -5*xc[1]*(35*xc[2]**4/(8*(xc[0]**2 + xc[1]**2 + xc[2]**2)**2) - 15*xc[2]**2/(4*(xc[0]**2 + xc[1]**2 + xc[2]**2)) + 0.375)/(xc[0]**2 + xc[1]**2 + xc[2]**2)**(7/2) + (-35*xc[1]*xc[2]**4/(2*(xc[0]**2 + xc[1]**2 + xc[2]**2)**3) + 15*xc[1]*xc[2]**2/(2*(xc[0]**2 + xc[1]**2 + xc[2]**2)**2))/(xc[0]**2 + xc[1]**2 + xc[2]**2)**(5/2)
    FJ4[2] = -5*xc[2]*(35*xc[2]**4/(8*(xc[0]**2 + xc[1]**2 + xc[2]**2)**2) - 15*xc[2]**2/(4*(xc[0]**2 + xc[1]**2 + xc[2]**2)) + 0.375)/(xc[0]**2 + xc[1]**2 + xc[2]**2)**(7/2) + (-35*xc[2]**5/(2*(xc[0]**2 + xc[1]**2 + xc[2]**2)**3) + 25*xc[2]**3/(xc[0]**2 + xc[1]**2 + xc[2]**2)**2 - 15*xc[2]/(2*(xc[0]**2 + xc[1]**2 + xc[2]**2)))/(xc[0]**2 + xc[1]**2 + xc[2]**2)**(5/2)
    
    FJ5 = zeros(3)
    FJ5[0] = -6*xc[0]*(63*xc[2]**5/(8*(xc[0]**2 + xc[1]**2 + xc[2]**2)**(5/2)) - 35*xc[2]**3/(4*(xc[0]**2 + xc[1]**2 + xc[2]**2)**(3/2)) + 15*xc[2]/(8*sqrt(xc[0]**2 + xc[1]**2 + xc[2]**2)))/(xc[0]**2 + xc[1]**2 + xc[2]**2)**4 + (-315*xc[0]*xc[2]**5/(8*(xc[0]**2 + xc[1]**2 + xc[2]**2)**(7/2)) + 105*xc[0]*xc[2]**3/(4*(xc[0]**2 + xc[1]**2 + xc[2]**2)**(5/2)) - 15*xc[0]*xc[2]/(8*(xc[0]**2 + xc[1]**2 + xc[2]**2)**(3/2)))/(xc[0]**2 + xc[1]**2 + xc[2]**2)**3
    FJ5[1] = -6*xc[1]*(63*xc[2]**5/(8*(xc[0]**2 + xc[1]**2 + xc[2]**2)**(5/2)) - 35*xc[2]**3/(4*(xc[0]**2 + xc[1]**2 + xc[2]**2)**(3/2)) + 15*xc[2]/(8*sqrt(xc[0]**2 + xc[1]**2 + xc[2]**2)))/(xc[0]**2 + xc[1]**2 + xc[2]**2)**4 + (-315*xc[1]*xc[2]**5/(8*(xc[0]**2 + xc[1]**2 + xc[2]**2)**(7/2)) + 105*xc[1]*xc[2]**3/(4*(xc[0]**2 + xc[1]**2 + xc[2]**2)**(5/2)) - 15*xc[1]*xc[2]/(8*(xc[0]**2 + xc[1]**2 + xc[2]**2)**(3/2)))/(xc[0]**2 + xc[1]**2 + xc[2]**2)**3
    FJ5[2] = -6*xc[2]*(63*xc[2]**5/(8*(xc[0]**2 + xc[1]**2 + xc[2]**2)**(5/2)) - 35*xc[2]**3/(4*(xc[0]**2 + xc[1]**2 + xc[2]**2)**(3/2)) + 15*xc[2]/(8*sqrt(xc[0]**2 + xc[1]**2 + xc[2]**2)))/(xc[0]**2 + xc[1]**2 + xc[2]**2)**4 + (-315*xc[2]**6/(8*(xc[0]**2 + xc[1]**2 + xc[2]**2)**(7/2)) + 525*xc[2]**4/(8*(xc[0]**2 + xc[1]**2 + xc[2]**2)**(5/2)) - 225*xc[2]**2/(8*(xc[0]**2 + xc[1]**2 + xc[2]**2)**(3/2)) + 15/(8*sqrt(xc[0]**2 + xc[1]**2 + xc[2]**2)))/(xc[0]**2 + xc[1]**2 + xc[2]**2)**3
    
    FJ6 = zeros(3)
    FJ6[0] = -7*xc[0]*(231*xc[2]**6/(16*(xc[0]**2 + xc[1]**2 + xc[2]**2)**3) - 315*xc[2]**4/(16*(xc[0]**2 + xc[1]**2 + xc[2]**2)**2) + 105*xc[2]**2/(16*(xc[0]**2 + xc[1]**2 + xc[2]**2)) - 0.3125)/(xc[0]**2 + xc[1]**2 + xc[2]**2)**(9/2) + (-693*xc[0]*xc[2]**6/(8*(xc[0]**2 + xc[1]**2 + xc[2]**2)**4) + 315*xc[0]*xc[2]**4/(4*(xc[0]**2 + xc[1]**2 + xc[2]**2)**3) - 105*xc[0]*xc[2]**2/(8*(xc[0]**2 + xc[1]**2 + xc[2]**2)**2))/(xc[0]**2 + xc[1]**2 + xc[2]**2)**(7/2)
    FJ6[1] = -7*xc[1]*(231*xc[2]**6/(16*(xc[0]**2 + xc[1]**2 + xc[2]**2)**3) - 315*xc[2]**4/(16*(xc[0]**2 + xc[1]**2 + xc[2]**2)**2) + 105*xc[2]**2/(16*(xc[0]**2 + xc[1]**2 + xc[2]**2)) - 0.3125)/(xc[0]**2 + xc[1]**2 + xc[2]**2)**(9/2) + (-693*xc[1]*xc[2]**6/(8*(xc[0]**2 + xc[1]**2 + xc[2]**2)**4) + 315*xc[1]*xc[2]**4/(4*(xc[0]**2 + xc[1]**2 + xc[2]**2)**3) - 105*xc[1]*xc[2]**2/(8*(xc[0]**2 + xc[1]**2 + xc[2]**2)**2))/(xc[0]**2 + xc[1]**2 + xc[2]**2)**(7/2)
    FJ6[2] = -7*xc[2]*(231*xc[2]**6/(16*(xc[0]**2 + xc[1]**2 + xc[2]**2)**3) - 315*xc[2]**4/(16*(xc[0]**2 + xc[1]**2 + xc[2]**2)**2) + 105*xc[2]**2/(16*(xc[0]**2 + xc[1]**2 + xc[2]**2)) - 0.3125)/(xc[0]**2 + xc[1]**2 + xc[2]**2)**(9/2) + (-693*xc[2]**7/(8*(xc[0]**2 + xc[1]**2 + xc[2]**2)**4) + 1323*xc[2]**5/(8*(xc[0]**2 + xc[1]**2 + xc[2]**2)**3) - 735*xc[2]**3/(8*(xc[0]**2 + xc[1]**2 + xc[2]**2)**2) + 105*xc[2]/(8*(xc[0]**2 + xc[1]**2 + xc[2]**2)))/(xc[0]**2 + xc[1]**2 + xc[2]**2)**(7/2)
    
    FJ7 = zeros(3)
    FJ7[0] = -8*xc[0]*(429*xc[2]**7/(16*(xc[0]**2 + xc[1]**2 + xc[2]**2)**(7/2)) - 693*xc[2]**5/(16*(xc[0]**2 + xc[1]**2 + xc[2]**2)**(5/2)) + 315*xc[2]**3/(16*(xc[0]**2 + xc[1]**2 + xc[2]**2)**(3/2)) - 35*xc[2]/(16*sqrt(xc[0]**2 + xc[1]**2 + xc[2]**2)))/(xc[0]**2 + xc[1]**2 + xc[2]**2)**5 + (-3003*xc[0]*xc[2]**7/(16*(xc[0]**2 + xc[1]**2 + xc[2]**2)**(9/2)) + 3465*xc[0]*xc[2]**5/(16*(xc[0]**2 + xc[1]**2 + xc[2]**2)**(7/2)) - 945*xc[0]*xc[2]**3/(16*(xc[0]**2 + xc[1]**2 + xc[2]**2)**(5/2)) + 35*xc[0]*xc[2]/(16*(xc[0]**2 + xc[1]**2 + xc[2]**2)**(3/2)))/(xc[0]**2 + xc[1]**2 + xc[2]**2)**4
    FJ7[1] = -8*xc[1]*(429*xc[2]**7/(16*(xc[0]**2 + xc[1]**2 + xc[2]**2)**(7/2)) - 693*xc[2]**5/(16*(xc[0]**2 + xc[1]**2 + xc[2]**2)**(5/2)) + 315*xc[2]**3/(16*(xc[0]**2 + xc[1]**2 + xc[2]**2)**(3/2)) - 35*xc[2]/(16*sqrt(xc[0]**2 + xc[1]**2 + xc[2]**2)))/(xc[0]**2 + xc[1]**2 + xc[2]**2)**5 + (-3003*xc[1]*xc[2]**7/(16*(xc[0]**2 + xc[1]**2 + xc[2]**2)**(9/2)) + 3465*xc[1]*xc[2]**5/(16*(xc[0]**2 + xc[1]**2 + xc[2]**2)**(7/2)) - 945*xc[1]*xc[2]**3/(16*(xc[0]**2 + xc[1]**2 + xc[2]**2)**(5/2)) + 35*xc[1]*xc[2]/(16*(xc[0]**2 + xc[1]**2 + xc[2]**2)**(3/2)))/(xc[0]**2 + xc[1]**2 + xc[2]**2)**4
    FJ7[2] = -8*xc[2]*(429*xc[2]**7/(16*(xc[0]**2 + xc[1]**2 + xc[2]**2)**(7/2)) - 693*xc[2]**5/(16*(xc[0]**2 + xc[1]**2 + xc[2]**2)**(5/2)) + 315*xc[2]**3/(16*(xc[0]**2 + xc[1]**2 + xc[2]**2)**(3/2)) - 35*xc[2]/(16*sqrt(xc[0]**2 + xc[1]**2 + xc[2]**2)))/(xc[0]**2 + xc[1]**2 + xc[2]**2)**5 + (-3003*xc[2]**8/(16*(xc[0]**2 + xc[1]**2 + xc[2]**2)**(9/2)) + 1617*xc[2]**6/(4*(xc[0]**2 + xc[1]**2 + xc[2]**2)**(7/2)) - 2205*xc[2]**4/(8*(xc[0]**2 + xc[1]**2 + xc[2]**2)**(5/2)) + 245*xc[2]**2/(4*(xc[0]**2 + xc[1]**2 + xc[2]**2)**(3/2)) - 35/(16*sqrt(xc[0]**2 + xc[1]**2 + xc[2]**2)))/(xc[0]**2 + xc[1]**2 + xc[2]**2)**4
 
    FJN = J4*FJ4 + J5*FJ5 + J6*FJ6 + J7*FJ7
   
    zp = zeros(6)
    zp[0:3] = xp
    zp[3:6] = R.T@(Fg + FJ2 + FJ3 - FJN - (2*Rp@xp + Rpp@x))

    return zp

t = linspace(0, deltaT, len(tiempo))
z_odeint = odeint(satelite, z0, t)

x_o = z_odeint[:,0]
y_o = z_odeint[:,1]
z_o = z_odeint[:,2]
vx_o = z_odeint[:,3]
vy_o = z_odeint[:,4]
vz_o = z_odeint[:,5]

''' ESCRITURA DE .PRED '''

eof_out = eofname.replace('.EOF', '.PRED')

with open(eof_out, 'w') as fout:
    fout.write('<?xml version="1.0" ?>\n')
    fout.write('<Earth_Explorer_File>\n')
    fout.write('<Data_Block type="xml">\n')
    fout.write(f'  <List_of_OSVs count="{len(tiempo)}">\n')
    for i in range(len(tiempo)):
        fout.write('    <OSV>\n')
        fout.write(f'      <UTC>UTC=2020-07-31T22:59:42.000000</UTC>\n      <X unit="m">{x_o[i]}</X>\n      <Y unit="m">{y_o[i]}</Y>\n      <Z unit="m">{z_o[i]}</Z>\n      <VX unit="m/s">{vx_o[i]}</VX>\n      <VY unit="m/s">{vy_o[i]}</VY>\n      <VZ unit="m/s">{vz_o[i]}</VZ>\n')
        fout.write('    </OSV>\n')
    fout.write('  </List_of_OSVs>\n')
    fout.write('</Data_Block>\n')
    fout.write('</Earth_Explorer_File>')

''' COMPARACION FINAL '''

#final_real = [x[-1],y[-1],z[-1]]
#
#xrf = x[-1]
#yrf = y[-1]
#zrf = z[-1]
#xof = x_o[-1]
#yof = y_o[-1]
#zof = z_o[-1]
#
#delta = sp.sqrt((xof-xrf)**2 + (yof-yrf)**2 + (zof-zrf)**2)
#print (delta/1000,'km')